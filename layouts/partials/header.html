<header style="width: 100%; position: relative;">
  <style>
    nav {
      display: flex !important;
      justify-content: center !important;
      align-items: center !important;
      width: 100% !important;
      padding: 0.5em 1em !important;
      position: relative !important;
    }

    .lang-switcher {
      display: flex !important;
      gap: 0.8em !important;
      font-size: 1.2em !important;
      position: absolute !important;
      top: 0.5em !important;
      right: 1em !important;
    }

    .top-menu {
      display: flex !important;
      justify-content: center !important;
      align-items: center !important;
      list-style: none !important;
      padding: 0 !important;
      margin: 0 !important;
      gap: 1em !important;
    }

    .top-menu li {
      margin: 0 !important;
    }

    @media (max-width: 768px) {
      nav {
        padding: 0.5em !important;
      }

      .lang-switcher {
        font-size: 1em !important;
        gap: 0.6em !important;
        top: 0.5em !important;
        right: 0.5em !important;
      }

      .top-menu {
        flex-wrap: wrap !important;
        gap: 0.5em !important;
        justify-content: center !important;
      }

      .top-menu li {
        margin: 0.25em 0.5em !important;
      }

      .top-menu a {
        font-size: 0.9em !important;
      }
    }
  </style>
  <nav>
    {{/* Build language switch links: prefer actual translations, fallback to computed path */}}
    {{ $path := .Page.RelPermalink | strings.TrimPrefix "/" | strings.TrimSuffix "/" }}
    {{ if hasPrefix $path "es/" }}
      {{ $path = $path | strings.TrimPrefix "es/" }}
    {{ end }}
    <div class="lang-switcher">
      {{ if eq $.Site.Language.Lang "en" }}
        <span style="opacity: 1 !important;">ðŸ‡¬ðŸ‡§</span>
        {{ $target := "" }}
        {{ range .Page.AllTranslations }}
          {{ if eq .Language.Lang "es" }}
            {{ $target = .RelPermalink }}
          {{ end }}
        {{ end }}
        {{ if $target }}
          <a href="{{ $target }}" style="text-decoration: none !important; opacity: 0.6 !important; transition: opacity 0.3s !important;">ðŸ‡ªðŸ‡¸</a>
        {{ else if eq $path "" }}
          <a href="/es/" style="text-decoration: none !important; opacity: 0.6 !important; transition: opacity 0.3s !important;">ðŸ‡ªðŸ‡¸</a>
        {{ else }}
          <a href="/es/{{ $path }}/" style="text-decoration: none !important; opacity: 0.6 !important; transition: opacity 0.3s !important;">ðŸ‡ªðŸ‡¸</a>
        {{ end }}
      {{ else }}
        {{ $target := "" }}
        {{ range .Page.AllTranslations }}
          {{ if eq .Language.Lang "en" }}
            {{ $target = .RelPermalink }}
          {{ end }}
        {{ end }}
        {{ if $target }}
          <a href="{{ $target }}" style="text-decoration: none !important; opacity: 0.6 !important; transition: opacity 0.3s !important;">ðŸ‡¬ðŸ‡§</a>
        {{ else if eq $path "" }}
          <a href="/" style="text-decoration: none !important; opacity: 0.6 !important; transition: opacity 0.3s !important;">ðŸ‡¬ðŸ‡§</a>
        {{ else }}
          <a href="/{{ $path }}/" style="text-decoration: none !important; opacity: 0.6 !important; transition: opacity 0.3s !important;">ðŸ‡¬ðŸ‡§</a>
        {{ end }}
        <span style="opacity: 1 !important;">ðŸ‡ªðŸ‡¸</span>
      {{ end }}
    </div>
    <ul class="top-menu">
      {{ range .Site.Menus.main }}
        <li>
          {{ if or (eq $.Page.Permalink (.URL | absLangURL)) (hasSuffix $.Page.Permalink (.URL | absLangURL)) }}
            <a href="{{ .URL | absLangURL }}" style="text-decoration: none !important; font-weight: 900 !important; color: var(--text-1); opacity: 1 !important;">{{ .Name }}</a>
          {{ else }}
            <a href="{{ .URL | absLangURL }}" style="text-decoration: none !important; font-weight: bold !important; opacity: 0.7 !important;">{{ .Name }}</a>
          {{ end }}
        </li>
      {{ end }}
    </ul>
  </nav>
</header>
<script>
  // Keep current photo across languages without showing it in the URL (uses localStorage)
  (function() {
    const KEY = 'galleryPhotoIndex';
    const langLinks = document.querySelectorAll('.lang-switcher a');

    function getCurrentIndex() {
      // First try to get from global variable
      if (typeof window.currentPhotoIndex === 'number') {
        return window.currentPhotoIndex;
      }
      // Fallback: read from localStorage
      try {
        const stored = localStorage.getItem(KEY);
        if (stored !== null) {
          return parseInt(stored, 10);
        }
      } catch (e) {}
      return null;
    }

    function storeCurrentIndex(index) {
      if (index !== null && Number.isFinite(index)) {
        try { 
          localStorage.setItem(KEY, index); 
          console.log('Stored photo index:', index);
        } catch (e) {
          console.error('Failed to store index', e);
        }
      }
    }

    // On click, store the current index then navigate
    langLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const currentIndex = getCurrentIndex();
        storeCurrentIndex(currentIndex);
        // Small delay to ensure localStorage write completes
        setTimeout(() => {
          window.location.href = link.href;
        }, 50);
      });
    });
  })();
</script>
